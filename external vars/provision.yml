---
- name: Update packages and install Docker, wget, jq, telnet, Java 8, kubectl on Amazon Linux
  hosts: localhost
  connection: local
  become: true

  vars_files:
    - vars.yml
  
  tasks:
    - name: Update all system packages
      yum:
        name: "*"
        state: latest
    - name : Install required packages
      yum:
        state: present
        name: "{{ yum_packages }}"
        
    - name: Start and enable Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Verify kubectl installation
      command: kubectl version --client
      environment:
        PATH: "{{ kubectl_download_path }}:{{ ansible_env.PATH }}"
      register: kubectl_output
      ignore_errors: true
  
    - name: Download kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: "{{ kubectl_download_path }}/kubectl"
        mode: '0755'
        force: yes  # Overwrite if it already exists'
      when: kubectl_output.rc != 0
    
    - name: Ensure kubectl is executable
      file:
        path: "{{ kubectl_download_path }}/kubectl"
        mode: '0755'
      when : kubectl_output.rc != 0


    - name: Download Helm
      get_url:
        url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
        dest: /tmp/helm.tar.gz
   
    - name: Unarchive Helm
      unarchive:        
          src: /tmp/helm.tar.gz
          dest: /tmp
          mode: '0755'
          remote_src: yes

    - name: Move Helm binary to /usr/local/bin
      copy:
        src: /tmp/linux-amd64/helm
        dest: /usr/local/bin/helm
        mode: '0755'




        
    # ------------------------
    # VERIFICATION SECTION
    # ------------------------

   
    - name: Verify wget is installed
      command: wget --version
      register: wget_version
      failed_when: wget_version.rc != 0
      changed_when: false

    - name: Verify jq is installed
      command: jq --version
      register: jq_version
      failed_when: jq_version.rc != 0
      changed_when: false

    - name: Verify telnet is installed
      #command: telnet --version
      command: telnet
      register: telnet_version
      failed_when: telnet_version.rc != 0
      changed_when: false

    - name: Verify Java 8 installation
      command: java -version
      register: java_version
      failed_when: "'1.8' not in java_version.stderr"
      changed_when: false
    
    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      failed_when: docker_version.rc != 0
      changed_when: false


    - name: Verify Docker service is running
      command: systemctl is-active docker
      register: docker_service_status
      failed_when: docker_service_status.stdout != "active"
      changed_when: false

  
    - name: Verify kubectl installation
      #command: "{{ kubectl_download_path }} version --client"
      command: kubectl version --client
      environment:
        #PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
        PATH: "{{ kubectl_download_path }}:{{ ansible_env.PATH }}"
      register: kubectl_version_check 
      failed_when: kubectl_version_check.rc != 0
      changed_when: false
   
    - name : Verify Helm installation
      command: /usr/local/bin/helm version
      register: helm_version 
      failed_when: helm_version.rc != 0
      changed_when: false 
      
